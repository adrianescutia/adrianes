---
title: Enable PL/Java in a Postgres database
description: Extension for PostgreSQL™ that allows stored procedures, triggers, and functions to be written in the Java™ language and executed in the backend.
categories: 
    - Postgres
---

## Install PL/Java

https://www.postgresql.org/docs/11/external-pl.html
https://github.com/tada/pljava/wiki
http://docs.greenplum.org/6-12/analytics/pl_java.html

postgresql-11-pljava_1.6.2-1.pgdg20.10+1_amd64.deb
http://apt.postgresql.org/pub/repos/apt/pool/main/p/postgresql-pljava/

```s
docker run --name postgres11 --network sa-network -v ./data11:/var/lib/postgresql/data -e POSTGRES_USER=poc -e POSTGRES_PASSWORD=mysecretpassword -p 5444:5432 -d postgres:11.11
```

Retrieve the IP of the database instace:  
`docker inspect -f '{{range.NetworkSettings.Networks}}{{.IPAddress}}{{end}}' postgres11`


apk --no-cache add openjdk11 --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community
apk add --no-cache pljava --repository=http://dl-cdn.alpinelinux.org/alpine/edge/community

```sql
CREATE EXTENSION pljava;
CREATE FUNCTION getsysprop(VARCHAR)
  RETURNS VARCHAR
  AS 'java.lang.System.getProperty'
  LANGUAGE java;

SELECT getsysprop('user.home');
-- /var/lib/postgresql
SELECT array_agg(getsysprop(p)) FROM (values
('org.postgresql.pljava.version'),
('org.postgresql.version'),
('java.version'),
('os.name'),
('os.arch')
) AS props(p);
-- {1.5.6,"11.11 (Debian 11.11-1.pgdg90+1)",1.8.0_275,Linux,amd64}
```

### Install

1. Enable PL/Java in a database by executing the CREATE EXTENSION command to register the language. For example, this command enables PL/Java in the testdb database:

    $ psql -d testdb -c 'CREATE EXTENSION pljava;'

2. Copy your Java archives (JAR files) to the same directory on all Database hosts. i.e.: $HOME/java/:

`SELECT sqlj.install_jar(`_/var/lib/postgresql/share/postgresql/pljava/pljava-examples-*.jar_`, 'ex', true);`

3. Set the pljava_classpath server configuration parameter. For example:

`SELECT sqlj.set_classpath('javatest', 'ex');`

Examples:

psql -f $HOME/share/postgresql/pljava/examples.sql


CREATE FUNCTION getsysprop(VARCHAR)
  RETURNS VARCHAR
  AS 'java.lang.System.getProperty'
  LANGUAGE java;

SELECT getsysprop('user.home');


------------------

### [Complex Types](http://docs.greenplum.org/6-12/analytics/pl_java.html#topic17)


CREATE TYPE complexTest
  AS(base integer, incbase integer, ctime timestamptz);
CREATE FUNCTION useComplexTest(complexTest)
  RETURNS VARCHAR
  AS 'foo.fee.Fum.useComplexTest'
  IMMUTABLE LANGUAGE java;
In the Java class Fum, we add the following static method:

public static String useComplexTest(ResultSet complexTest)
throws SQLException
{
  int base = complexTest.getInt(1);
  int incbase = complexTest.getInt(2);
  Timestamp ctime = complexTest.getTimestamp(3);
  return "Base = \"" + base +
    "\", incbase = \"" + incbase +
    "\", ctime = \"" + ctime + "\"";
}




Ref: [don't make plpython3u into a trusted language](https://dba.stackexchange.com/a/37342)
CREATE ROLE mydba WITH SUPERUSER NOINHERIT;
GRANT mydba TO nfvd;
select * from pg_language;

CREATE USER vsop_nfvd WITH PASSWORD 'nfvdHPE1nvent';
CREATE DATABASE nfvd OWNER vsop_nfvd;
CREATE USER vsop_sd WITH PASSWORD 'sdHPE1nvent';
CREATE DATABASE sd OWNER vsop_sd;

-- nfvd user
CREATE TABLE IF NOT EXISTS vnf_package_template (
    id              integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name            varchar(30),
    version         varchar(10),        -- the vnf template version
    filebroker_id   uuid,               -- the file broker UUID
    last_update     date
);



CREATE OR REPLACE FUNCTION public.notify_new_template(p_url text, p_method text DEFAULT 'POST'::text, p_data text DEFAULT ''::text, p_headers text DEFAULT '{"Content-Type": "application/json"}'::text)
 RETURNS text
 LANGUAGE plpython2u
AS $function$
    import requests, json
    try:
        r = requests.request(method=p_method, url=p_url, data=p_data, headers=json.loads(p_headers))
    except Exception as e:
        return e
    else:
        return r.content
$function$
;

CREATE TRIGGER template_insert
    AFTER INSERT ON vnf_package_template
    REFERENCING NEW TABLE AS template_inserted
    FOR EACH STATEMENT
    EXECUTE FUNCTION notify_new_template("http://localhost/");
    

-- sd user
CREATE TABLE IF NOT EXISTS vnf_package (
    id              integer PRIMARY KEY GENERATED BY DEFAULT AS IDENTITY,
    name            varchar(30),
    version         varchar(10),        -- the vnf template version
    filebroker_id   uuid,               -- the file broker UUID
    last_update     date
);

INSERT INTO vnf_package_template 
    VALUES ('NRF', '1.0', uuid_generate_v4(), now());
INSERT INTO vnf_package_template 
    VALUES ('NRF', '1.1', uuid_generate_v4(), now());


https://www.postgresql.org/docs/11/sql-createtrigger.html

CREATE [ CONSTRAINT ] TRIGGER name { BEFORE | AFTER | INSTEAD OF } { event [ OR ... ] }
    ON table_name
    [ FROM referenced_table_name ]
    [ NOT DEFERRABLE | [ DEFERRABLE ] [ INITIALLY IMMEDIATE | INITIALLY DEFERRED ] ]
    [ REFERENCING { { OLD | NEW } TABLE [ AS ] transition_relation_name } [ ... ] ]
    [ FOR [ EACH ] { ROW | STATEMENT } ]
    [ WHEN ( condition ) ]
    EXECUTE { FUNCTION | PROCEDURE } function_name ( arguments )

where event can be one of:

    INSERT
    UPDATE [ OF column_name [, ... ] ]
    DELETE
    TRUNCATE


CREATE TRIGGER log_update
    AFTER UPDATE ON accounts
    FOR EACH ROW
    WHEN (OLD.* IS DISTINCT FROM NEW.*)
    EXECUTE FUNCTION log_account_update(OLD.*, NEW.*);




